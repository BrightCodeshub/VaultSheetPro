(()=>{"use strict";const g=(e,t="ok")=>{const n=document.getElementById("toastContainer"),o=document.createElement("div");o.className=`toast${"err"===t?" err":""}`,o.innerHTML=`<span class="material-icons">${"err"===t?"error":"check"}</span>${e}`,n.appendChild(o),setTimeout(()=>o.remove(),4e3)},q=e=>e.toISOString().slice(0,19).replace("T"," "),B=()=>q(new Date),F=e=>new Date(e).toLocaleString(),H=e=>{if(!e)return!1;const t=e.replace(/^(https?:\/\/)?(www\.)?/,"");return/^[\\w.-]+\\.[A-Za-z]{2,}$/.test(t)},J=e=>{const t=e.trim();return/^https?:\\/\\//.test(t)?t:`https://${t}`};let k=[],C=[],x=1,y=0,m=[],p=1,v=null,w=null,L=null,S=null;const N=20;let d,h,u=!1;const $=e=>document.getElementById(e),O=()=>{y=1,document.getElementById("tbl").innerHTML="",m=k.filter(e=>JSON.stringify(e).toLowerCase().includes($("q").value.trim().toLowerCase())),T(),E()},T=()=>{const e=document.getElementById("tbl");e.innerHTML="";const t=(y-1)*N,n=m.slice(t,t+N);n.forEach(t=>{const n=document.createElement("tr");n.innerHTML=`<td>${t.id}</td><td>${t.u}</td><td><span data-p="${t.p}">${"â€¢".repeat(Math.min(12,t.p.length))}</span></td><td>${t.d?`<a href="#" data-l="${t.d}">${t.d}</a>`:""}</td><td>${t.c}</td><td>${t.cat}</td><td>${F(t.cr)}</td><td>${F(t.up)}</td><td><button data-e="${t.id}">âœŽ</button><button data-x="${t.id}">ðŸ—‘</button></td>`,e.appendChild(n)}),$("pgInfo").textContent=`${m.length?`${t+1}-${t+n.length} / ${m.length}`:"No data"}`},E=()=>{const e=$("pg");e.innerHTML="";const t=Math.ceil(m.length/N);if(t<2)return;for(let n=1;n<=t;n++){const t=document.createElement("button");t.textContent=n,t.className=n===y?"act":"",t.onclick=()=>{y=n,T(),E()},e.appendChild(t)}},M=()=>{const e=$("cat");e.innerHTML="<option></option>",C.forEach(t=>{const n=document.createElement("option");n.value=n.textContent=t,e.appendChild(n)})},P={y:()=>{localStorage.setItem("vspOK","1"),$("privacy").style.display="none",I()},n:()=>{g("See you next time","err"),setTimeout(()=>window.close(),1e3)}},R=async e=>{const t=L.Sheets.Data?XLSX.utils.sheet_to_json(L.Sheets.Data,{header:1}).slice(1):[];k=t.map(e=>({id:+e[0],u:e[1],p:e,d:e,c:e,cat:e,cr:e,up:e})),x=k.reduce((e,t)=>Math.max(e,t.id),0)+1,C=(L.Sheets["category-master"]?XLSX.utils.sheet_to_json(L.Sheets["category-master"],{header:1}).slice(1):["Personal","Work"]).map(e=>e||e),M(),O(),g(e?"Vault loaded":"New vault created")},I=()=>{$("visN").textContent="â€¦",fetch("https://api.countapi.xyz/hit/vaultsheet/vis").then(e=>e.json()).then(e=>$("visN").textContent=e.value).catch(()=>$("visN").textContent="offline"),$("pick").onclick=async()=>{try{$("pick").disabled=!0,v=await window.showDirectoryPicker({mode:"readwrite"}),w=await v.getFileHandle("data.xlsx",{create:!0}),S=await w.getFile(),L=S.size?XLSX.read(await S.arrayBuffer(),{type:"array"}):XLSX.utils.book_new(),await R(!!S.size),$("stat").textContent=`Connected â–¶ ${v.name}`,$("side").classList.remove("hide")}catch(e){g("Folder access cancelled","err")}finally{$("pick").disabled=!1}},$("save").onclick=async()=>{const e=$("u").value.trim(),t=$("p").value.trim(),n=$("d").value.trim(),o=$("c").value.trim(),r=$("cat").value.trim();if(!e||!t||!r)return g("Fill required fields","err");y?Object.assign(k.find(e=>e.id===y),{u:e,p:t,d:n,c:o,cat:r,up:B()}):k.push({id:x++,u:e,p:t,d:n,c:o,cat:r,cr:B(),up:B()}),await U(),O(),$("u").value=$("p").value=$("d").value=$("c").value="",$("cat").value="",y=0,$("sTxt").textContent="Save"},$("clr").onclick=()=>{$("u").value=$("p").value=$("d").value=$("c").value="",y=0,$("sTxt").textContent="Save"},$("exp").onclick=U,$("tbl").onclick=async e=>{const t=e.target;if(t.dataset.e){const e=k.find(e=>e.id==t.dataset.e);$("u").value=e.u,$("p").value=e.p,$("d").value=e.d,$("c").value=e.c,$("cat").value=e.cat,y=e.id,$("sTxt").textContent="Update"}else if(t.dataset.x){if(!confirm("Delete entry?"))return;k=k.filter(e=>e.id!=t.dataset.x),await U(),O()}else if(t.dataset.p){t.textContent=t.textContent.startsWith("â€¢")?t.dataset.p:"â€¢".repeat(Math.min(12,t.dataset.p.length))}else if(t.closest("a")){e.preventDefault();const n=t.closest("a").dataset.l;H(n)&&window.open(J(n),\"_blank\")}},$("show").onclick=()=>{$(\"p\").type=\"password\"===$(\"p\").type?\"text\":\"password\"},$(\"tgl\").onclick=()=>$(\"side\").classList.toggle(\"hide\"),document.addEventListener(\"keydown\",e=>{e.ctrlKey&&\"b\"===e.key&&($(\"side\").classList.toggle(\"hide\"),e.preventDefault())}),$(\"q\").oninput=O,$(\"cat\").ondblclick=()=>{K.open()},K.init()},U=async()=>{const e=[[\"ID\",\"Username\",\"Password\",\"Domain\",\"Comments\",\"Category\",\"Created\",\"Updated\"],...k.map(e=>[e.id,e.u,e.p,e.d,e.c,e.cat,e.cr,e.up])],t=[[\"Category\"],...C.map(e=>[e])];L.Sheets.Data=XLSX.utils.aoa_to_sheet(e),L.Sheets[\"category-master\"]=XLSX.utils.aoa_to_sheet(t);const n=XLSX.write(L,{bookType:\"xlsx\",type:\"array\"}),o=await w.createWritable();await o.write(n),await o.close()};

const K={open:()=>{$(\"catM\").style.display=\"flex\",K.list()},close:()=>{$(\"catM\").style.display=\"none\"},list:()=>{$(\"catList\").innerHTML=\"\",C.forEach(e=>{const t=document.createElement(\"li\");t.textContent=e,t.onclick=()=>{if(!confirm(\"Delete \"+e+\" ?\"))return;C=C.filter(t=>t!==e),M(),K.list(),U()},$(\"catList\").appendChild(t)})},add:()=>{const e=$(\"nCat\").value.trim();if(!e||C.includes(e))return;C.push(e),$(\"nCat\").value=\"\",M(),K.list()}};

window.addEventListener(\"beforeunload\",()=>U()),window.goToPage=e=>{y=e,T(),E()},window.addCategory=K.add,window.deleteCategory=K.list,window.closeCategoryModal=K.close,window.handleStartupAction=()=>$(\"pick\").click(),window.acceptPrivacyTerms=P.y,window.declineAndExit=P.n;

document.addEventListener(\"DOMContentLoaded\",()=>{localStorage.getItem(\"vspOK\")?($(\"privacy\").style.display=\"none\",I()):$(\"privacy\").style.display=\"flex\"})})();
